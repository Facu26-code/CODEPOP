<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODEPOP - Gesti√≥n Pro</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            background: #1a1a2e;
            color: white;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
        }

        h1 { margin-bottom: 5px; text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        h3 { margin: 10px 0; color: #00f3ff; }

        .panel-control {
            background: #16213e;
            padding: 25px;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 20px;
            width: 90%;
            max-width: 500px;
        }

        input, select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #30344c;
            background-color: #0f3460;
            color: white;
            width: 90%;
            margin-bottom: 10px;
            outline: none;
            font-size: 16px;
            text-align: center;
            transition: 0.3s;
        }

        input:focus, select:focus { 
            border-color: #00f3ff; 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
            transform: scale(1.02);
        }

        .btn-container { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;}

        button {
            cursor: pointer; border: none; border-radius: 8px; font-weight: bold;
            padding: 12px 20px; transition: 0.2s;
        }

        .btn-add { background: #00f3ff; color: #000; box-shadow: 0 0 10px rgba(0, 243, 255, 0.4); }
        .btn-empty { background: #ff0055; color: white; }
        .btn-excel { background: #1D6F42; color: white; box-shadow: 0 0 10px rgba(29, 111, 66, 0.4); }
        .btn-open { background: #6c5ce7; color: white; margin-left: 10px; }
        .btn-whatsapp { background: #25D366; color: white; box-shadow: 0 0 10px rgba(37, 211, 102, 0.4); }

        button:active { transform: scale(0.95); }

        ul { list-style-type: none; padding: 0; max-width: 500px; margin: 0 auto; }

        li {
            background-color: #16213e;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #00f3ff;
            display: flex; justify-content: space-between; align-items: center;
            animation: aparecer 0.3s ease-out; text-align: left;
            margin-bottom: 10px;
        }
        
        li.mano-obra { border-left: 5px solid #ff9f43; }

        .info-producto { display: flex; flex-direction: column; }
        .nombre-item { font-weight: bold; font-size: 1.1em; color: #fff; }
        .detalle-item { font-size: 0.9em; color: #aaa; }
        
        .rubro-badge {
            background: #ff9f43; color: black; font-size: 0.7em; padding: 2px 6px;
            border-radius: 4px; margin-left: 8px; text-transform: uppercase; font-weight: bold;
        }
        
        .cantidad-badge { 
            background: #00f3ff; color: black; padding: 2px 8px; 
            border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-right: 5px;
        }

        .acciones { display: flex; gap: 5px; }

        .btn-delete {
            background: transparent; border: 1px solid #ff4d4d; color: #ff4d4d;
            border-radius: 5px; width: 35px; height: 35px; padding: 0; font-size: 16px;
        }
        .btn-delete:hover { background: #ff4d4d; color: white; }

        .btn-edit {
            background: transparent; border: 1px solid #ffcc00; color: #ffcc00;
            border-radius: 5px; width: 35px; height: 35px; padding: 0; font-size: 16px;
        }
        .btn-edit:hover { background: #ffcc00; color: black; }

        .caja-total {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            padding: 15px;
            border-radius: 10px;
            margin-top: 30px;
            display: inline-block;
            box-shadow: 0 0 20px rgba(150, 201, 61, 0.4);
            animation: aparecer 0.5s ease-out;
            width: 90%; max-width: 500px;
        }
        
        .subtotales {
            font-size: 0.9em; color: #ddd; margin-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;
        }

        @keyframes aparecer {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .titulo-seccion {
            text-align: left; max-width: 500px; margin: 20px auto 5px auto;
            font-size: 0.9em; color: #aaa; text-transform: uppercase;
            letter-spacing: 1px; border-bottom: 1px solid #30344c;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>

<body>

    <div id="vista-clientes">
        <h1>üìÇ MIS PROYECTOS</h1>
        
        <div class="panel-control">
            <input type="text" id="nuevoClienteInput" placeholder="Nombre Cliente (Ej: Juan)">
            
            <select id="rubroInput">
                <option value="‚ö° Electricidad">‚ö° Electricidad</option>
                <option value="üîß Mec√°nica">üîß Mec√°nica</option>
                <option value="üìã Gestor Automotor">üìã Gestor Automotor</option>
                <option value="üî• Gasista">üî• Gasista</option>
                <option value="üõ†Ô∏è Varios">üõ†Ô∏è Varios</option>
            </select>

            <div class="btn-container">
                <button class="btn-add" onclick="crearNuevoCliente()">+ CREAR NUEVO</button>
            </div>
        </div>

        <ul id="listaClientesVisual"></ul>
    </div>


    <div id="vista-presupuesto" style="display:none;">
        
        <div style="text-align: left; max-width: 500px; margin: 0 auto; margin-bottom: 10px;">
            <button class="btn-empty" onclick="volverInicio()">&#11013; VOLVER</button>
        </div>

        <h1 id="tituloPresupuesto">PRESUPUESTO</h1>
        <h4 id="subtituloRubro" style="color:#00f3ff; margin-top:-10px;"></h4>
        
        <div class="panel-control">
            <select id="tipoItemInput" style="background-color: #2c3e50; border-color: #00f3ff;">
                <option value="material">üî© MATERIAL</option>
                <option value="mano_obra">üë∑ MANO DE OBRA</option>
            </select>

            <input list="listaPrecios" type="text" id="nombreInput" placeholder="Descripci√≥n">
            <datalist id="listaPrecios"></datalist>

            <input type="number" id="cantidadInput" placeholder="Cantidad" min="1">
            <input type="number" id="precioInput" placeholder="Precio Unidad" min="0">
            
            <div class="btn-container">
                <button class="btn-add" onclick="agregarProducto()">GUARDAR</button>
                <button class="btn-excel" onclick="descargarExcel()">üì• EXCEL</button>
                <button class="btn-whatsapp" onclick="compartirWhatsapp()">üì± WHATSAPP</button>
            </div>
        </div>

        <div id="contenedorListas"></div>

        <div class="caja-total">
            <div class="subtotales">
                üî© Materiales: $<span id="totalMateriales">0</span> <br>
                üë∑ Mano de Obra: $<span id="totalManoObra">0</span>
            </div>
            <h3>üí∞ TOTAL FINAL: $<span id="precioTotal">0</span></h3>
        </div>
    </div>

    <script>
        let baseDatos = JSON.parse(localStorage.getItem('CODEPOP_DB')) || [];
        let clienteActualIndex = null;

        // --- BASE DE PRECIOS DE MERCADO ---
        const PRECIOS_MERCADO = {
            "material": [
                { nombre: "Cable 2.5mm (Rollo)", precio: 45000 },
                { nombre: "Cable 1.5mm (Rollo)", precio: 38000 },
                { nombre: "Tecla Punto y Toma", precio: 3500 },
                { nombre: "Cinta Aisladora", precio: 1500 },
                { nombre: "Aceite 10w40", precio: 12000 },
                { nombre: "Filtro de Aire", precio: 8000 },
                { nombre: "Formularios Tipo 08", precio: 5000 }
            ],
            // LISTA DE MANO DE OBRA ACTUALIZADA
            "mano_obra": {
                "‚ö° Electricidad": [
                    { nombre: "Boca de luz (Instalaci√≥n)", precio: 15000 },
                    { nombre: "Cambio de T√©rmica", precio: 25000 },
                    { nombre: "Urgencia 24hs", precio: 40000 }
                ],
                "üîß Mec√°nica": [
                    { nombre: "Electricidad Automotriz", precio: 25000 },
                    { nombre: "Escaneo Computarizado", precio: 20000 },
                    { nombre: "Mec√°nica Integral", precio: 30000 },
                    { nombre: "Cambio de Aceite", precio: 10000 }
                ],
                "üìã Gestor Automotor": [
                    { nombre: "Transferencia Automotor", precio: 50000 },
                    { nombre: "Cambio de Dominio", precio: 40000 },
                    { nombre: "C√©dula Azul/Verde", precio: 15000 },
                    { nombre: "Informe de Dominio", precio: 10000 }
                ],
                "üî• Gasista": [
                    { nombre: "Instalaci√≥n Estufa", precio: 35000 },
                    { nombre: "B√∫squeda de Fuga", precio: 40000 },
                    { nombre: "Matriculaci√≥n", precio: 60000 }
                ],
                "üõ†Ô∏è Varios": [
                    { nombre: "Trabajos de Oficina", precio: 10000 },
                    { nombre: "Finanzas / Contador", precio: 20000 },
                    { nombre: "Tr√°mites Generales", precio: 8000 }
                ]
            }
        };

        // --- GESTI√ìN DE CLIENTES ---

        const crearNuevoCliente = () => {
            let nombre = document.getElementById('nuevoClienteInput').value;
            let rubro = document.getElementById('rubroInput').value;
            
            if (nombre === "") {
                Swal.fire({ title: 'Falta nombre', icon: 'warning', background: '#16213e', color: '#fff' });
                return;
            }

            let nuevoCliente = {
                id: Date.now(), 
                nombre: nombre,
                rubro: rubro,
                items: [] 
            };

            baseDatos.push(nuevoCliente);
            guardarDB();
            
            document.getElementById('nuevoClienteInput').value = "";
            mostrarClientes(); 
        }

        const mostrarClientes = () => {
            let listaHTML = document.getElementById('listaClientesVisual');
            listaHTML.innerHTML = "";

            if(baseDatos.length === 0) {
                listaHTML.innerHTML = "<p style='color:#aaa'>No tienes proyectos a√∫n.</p>";
                return;
            }

            baseDatos.forEach((cliente, index) => {
                let totalItems = cliente.items.length;
                let rubroMostrar = cliente.rubro || 'üõ†Ô∏è Varios'; 
                
                let html = `
                    <li>
                        <div class="info-producto">
                            <span class="nombre-item">
                                ${cliente.nombre}
                                <span class="rubro-badge">${rubroMostrar}</span>
                            </span>
                            <span class="detalle-item">${totalItems} items guardados</span>
                        </div>
                        <div>
                             <button class="btn-delete" onclick="borrarCliente(${index})">‚úï</button>
                             <button class="btn-open" onclick="abrirPresupuesto(${index})">ABRIR ‚ûú</button>
                        </div>
                    </li>
                `;
                listaHTML.innerHTML += html;
            });
        }

        const borrarCliente = (index) => {
            Swal.fire({
                title: '¬øBorrar proyecto?',
                text: "Se perder√°n todos los datos.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                background: '#16213e', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    baseDatos.splice(index, 1);
                    guardarDB();
                    mostrarClientes();
                }
            })
        }

        const abrirPresupuesto = (index) => {
            clienteActualIndex = index;
            let cliente = baseDatos[index];

            document.getElementById('tituloPresupuesto').innerText = "OBRA: " + cliente.nombre.toUpperCase();
            document.getElementById('subtituloRubro').innerText = cliente.rubro || "Rubro: Varios";

            document.getElementById('vista-clientes').style.display = 'none';
            document.getElementById('vista-presupuesto').style.display = 'block';

            // Reseteamos el selector y cargamos sugerencias iniciales
            document.getElementById('tipoItemInput').value = "material";
            cambiarPlaceholders();
            actualizarSugerencias();

            actualizarVistaPresupuesto();
        }

        const volverInicio = () => {
            clienteActualIndex = null; 
            document.getElementById('vista-presupuesto').style.display = 'none';
            document.getElementById('vista-clientes').style.display = 'block';
            mostrarClientes(); 
        }

        // --- L√ìGICA INTELIGENTE DE PRECIOS Y VISIBILIDAD ---

        const cambiarPlaceholders = () => {
            let tipo = document.getElementById('tipoItemInput').value;
            let nombreInput = document.getElementById('nombreInput');
            let cantidadInput = document.getElementById('cantidadInput');
            let precioInput = document.getElementById('precioInput');

            if (tipo === 'mano_obra') {
                nombreInput.placeholder = "Trabajo a realizar (Ej: Instalaci√≥n)";
                precioInput.placeholder = "Precio Final del Trabajo";
                
                // OCULTAR CANTIDAD
                cantidadInput.style.display = 'none';
                cantidadInput.value = 1; 
            } else {
                nombreInput.placeholder = "Material (Ej: Cable)";
                precioInput.placeholder = "Precio Unitario";
                
                // MOSTRAR CANTIDAD
                cantidadInput.style.display = 'inline-block';
                cantidadInput.value = ""; 
            }
            // Recargamos la lista de autocompletado
            actualizarSugerencias();
        }

        const actualizarSugerencias = () => {
            let tipo = document.getElementById('tipoItemInput').value;
            let cliente = baseDatos[clienteActualIndex];
            let rubro = cliente.rubro || "üõ†Ô∏è Varios";
            let lista = document.getElementById('listaPrecios');
            
            lista.innerHTML = ""; 

            let opciones = [];

            if (tipo === 'material') {
                opciones = PRECIOS_MERCADO.material;
            } else {
                // Buscamos las opciones del rubro o vamos a Varios
                opciones = PRECIOS_MERCADO.mano_obra[rubro] || PRECIOS_MERCADO.mano_obra["üõ†Ô∏è Varios"];
            }

            if (opciones) {
                opciones.forEach(item => {
                    let option = document.createElement('option');
                    option.value = item.nombre;
                    option.setAttribute('data-precio', item.precio); 
                    lista.appendChild(option);
                });
            }
        }

        const autocompletarPrecio = () => {
            let nombreIngresado = document.getElementById('nombreInput').value;
            let tipo = document.getElementById('tipoItemInput').value;
            let cliente = baseDatos[clienteActualIndex];
            let rubro = cliente.rubro || "üõ†Ô∏è Varios";

            let listaItems = [];
            if (tipo === 'material') {
                listaItems = PRECIOS_MERCADO.material;
            } else {
                listaItems = PRECIOS_MERCADO.mano_obra[rubro] || PRECIOS_MERCADO.mano_obra["üõ†Ô∏è Varios"];
            }

            // IMPORTANTE: Permitimos escribir nombres nuevos.
            // Solo si coincide exactamente con la lista, ponemos el precio.
            let encontrado = listaItems.find(item => item.nombre === nombreIngresado);

            if (encontrado) {
                document.getElementById('precioInput').value = encontrado.precio;
            }
        }


        // --- FUNCIONES DEL PRESUPUESTO ---

        const agregarProducto = () => {
            let tipo = document.getElementById('tipoItemInput').value;
            let nombre = document.getElementById('nombreInput').value;
            let cantidad = document.getElementById('cantidadInput').value;
            let precio = document.getElementById('precioInput').value;

            if (nombre === "" || cantidad === "" || precio === "") return;

            let nuevoItem = {
                tipo: tipo,
                nombre: nombre,
                cantidad: parseInt(cantidad), // Si est√° oculto, tomar√° el 1 que pusimos
                precio: parseFloat(precio)
            };

            baseDatos[clienteActualIndex].items.push(nuevoItem);
            
            document.getElementById('nombreInput').value ="";
            if(tipo === 'material') document.getElementById('cantidadInput').value = "";
            
            document.getElementById('precioInput').value = "";
            document.getElementById('nombreInput').focus();
            
            guardarDB();
            actualizarVistaPresupuesto();
            
            Swal.fire({
                position: 'top-end', icon: 'success', title: 'Guardado', 
                showConfirmButton: false, timer: 800, background: '#16213e', color: '#fff'
            });
        }

        const actualizarVistaPresupuesto = () => {
            let contenedor = document.getElementById('contenedorListas');
            contenedor.innerHTML = "";
            
            let itemsCliente = baseDatos[clienteActualIndex].items;
            
            let sumaMateriales = 0;
            let sumaManoObra = 0;
            let htmlMateriales = "";
            let htmlManoObra = "";

            itemsCliente.forEach((producto, i) => {
                let subtotal = producto.cantidad * producto.precio;
                
                if (producto.tipo === 'mano_obra') {
                    sumaManoObra += subtotal;
                } else {
                    sumaMateriales += subtotal;
                }

                let claseExtra = (producto.tipo === 'mano_obra') ? 'mano-obra' : '';
                let icono = (producto.tipo === 'mano_obra') ? 'üë∑' : 'üî©';
                
                let cantidadTexto = (producto.tipo === 'mano_obra') 
                    ? '' 
                    : `<span class="cantidad-badge">${producto.cantidad}x</span>`;

                let htmlItem = `
                    <li class="${claseExtra}">
                        <div class="info-producto">
                            <span class="nombre-item">
                                ${cantidadTexto} 
                                ${icono} ${producto.nombre}
                            </span>
                            <span class="detalle-item">
                                $${producto.precio.toLocaleString()} | Sub: $${subtotal.toLocaleString()}
                            </span>
                        </div>
                        <div class="acciones">
                            <button class="btn-edit" onclick="editarItem(${i})">‚úé</button>
                            <button class="btn-delete" onclick="borrarItem(${i})">‚úï</button>
                        </div>
                    </li>
                `;

                if (producto.tipo === 'mano_obra') {
                    htmlManoObra += htmlItem;
                } else {
                    htmlMateriales += htmlItem;
                }
            });

            if (htmlMateriales !== "") {
                contenedor.innerHTML += `<div class="titulo-seccion">üî© MATERIALES</div><ul>${htmlMateriales}</ul>`;
            }
            if (htmlManoObra !== "") {
                contenedor.innerHTML += `<div class="titulo-seccion">üë∑ MANO DE OBRA</div><ul>${htmlManoObra}</ul>`;
            }
            if (itemsCliente.length === 0) {
                contenedor.innerHTML = "<p style='color:#666'>Lista vac√≠a</p>";
            }

            document.getElementById('totalMateriales').innerText = sumaMateriales.toLocaleString();
            document.getElementById('totalManoObra').innerText = sumaManoObra.toLocaleString();
            document.getElementById('precioTotal').innerText = (sumaMateriales + sumaManoObra).toLocaleString();
        }

        const borrarItem = (i) => {
            baseDatos[clienteActualIndex].items.splice(i, 1);
            guardarDB();
            actualizarVistaPresupuesto();
        }

        const editarItem = (i) => {
            let item = baseDatos[clienteActualIndex].items[i];
            
            document.getElementById('nombreInput').value = item.nombre;
            document.getElementById('cantidadInput').value = item.cantidad;
            document.getElementById('precioInput').value = item.precio;
            
            let selectTipo = document.getElementById('tipoItemInput');
            selectTipo.value = item.tipo || 'material';
            
            cambiarPlaceholders();

            borrarItem(i); 
        }

        const guardarDB = () => {
            localStorage.setItem('CODEPOP_DB', JSON.stringify(baseDatos));
        }

        const descargarExcel = () => {
            let cliente = baseDatos[clienteActualIndex];
            if (cliente.items.length === 0) {
                Swal.fire({ icon: 'info', title: 'Vac√≠o', text: 'Agrega items primero', background: '#16213e', color: '#fff' });
                return;
            }

            let datos = cliente.items.map(item => ({
                "Tipo": (item.tipo === 'mano_obra') ? "Mano de Obra" : "Material",
                "Descripci√≥n": item.nombre, 
                "Cantidad": (item.tipo === 'mano_obra') ? '-' : item.cantidad, 
                "Precio Unitario": item.precio, 
                "Subtotal": item.cantidad * item.precio
            }));

            let hoja = XLSX.utils.json_to_sheet(datos);
            let libro = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(libro, hoja, "Presupuesto");
            XLSX.writeFile(libro, "Presupuesto_" + cliente.nombre + ".xlsx");
        }

        const compartirWhatsapp = () => {
            let cliente = baseDatos[clienteActualIndex];
            let items = cliente.items;
            
            if (items.length === 0) {
                Swal.fire({ icon: 'info', title: 'Vac√≠o', text: 'Nada para enviar', background: '#16213e', color: '#fff' });
                return;
            }

            let mat = 0;
            let mo = 0;
            items.forEach(i => {
                if(i.tipo === 'mano_obra') mo += (i.cantidad * i.precio);
                else mat += (i.cantidad * i.precio);
            });
            let total = mat + mo;

            let texto = `Hola ${cliente.nombre}. Te paso el presupuesto de ${cliente.rubro || 'la obra'}:\n\n` +
                        `üî© Materiales: $${mat.toLocaleString()}\n` +
                        `üë∑ Mano de Obra: $${mo.toLocaleString()}\n` +
                        `üí∞ *TOTAL: $${total.toLocaleString()}*\n\n` +
                        `Av√≠same si avanzamos.`;

            let textoCodificado = encodeURIComponent(texto);
            window.open(`https://wa.me/?text=${textoCodificado}`, '_blank');
        }
        
        // --- INICIALIZACI√ìN Y EVENTOS ---
        
        mostrarClientes();

        document.getElementById('tipoItemInput').addEventListener('change', cambiarPlaceholders);
        document.getElementById('nombreInput').addEventListener('input', autocompletarPrecio);

        // Teclas R√°pidas
         document.getElementById('nombreInput').addEventListener('keydown', (e) => {
            if (e.key === "Enter") { e.preventDefault(); document.getElementById('cantidadInput').focus(); }
        });
        document.getElementById('cantidadInput').addEventListener('keydown', (e) => {
            if (e.key === "Enter") { e.preventDefault(); document.getElementById('precioInput').focus(); }
        });
        document.getElementById('precioInput').addEventListener('keydown', (e) => {
            if (e.key === "Enter") agregarProducto();
        });

    </script>
</body>
</html>
