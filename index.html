<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODEPOP - Gesti√≥n</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            background: #1a1a2e;
            color: white;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
        }

        h1 { margin-bottom: 5px; text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }

        .panel-control {
            background: #16213e;
            padding: 25px;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            margin-bottom: 20px;
            width: 90%;
            max-width: 500px;
        }

        input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #30344c;
            background-color: #0f3460;
            color: white;
            width: 90%;
            margin-bottom: 10px;
            outline: none;
            font-size: 16px;
            text-align: center;
            transition: 0.3s;
        }

        input:focus { 
            border-color: #00f3ff; 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
            transform: scale(1.02);
        }

        .btn-container { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;}

        button {
            cursor: pointer; border: none; border-radius: 8px; font-weight: bold;
            padding: 12px 20px; transition: 0.2s;
        }

        .btn-add { background: #00f3ff; color: #000; box-shadow: 0 0 10px rgba(0, 243, 255, 0.4); }
        .btn-empty { background: #ff0055; color: white; }
        .btn-excel { background: #1D6F42; color: white; box-shadow: 0 0 10px rgba(29, 111, 66, 0.4); }
        .btn-open { background: #6c5ce7; color: white; margin-left: 10px; }
        
        /* BOT√ìN WHATSAPP */
        .btn-whatsapp { 
            background: #25D366; 
            color: white; 
            box-shadow: 0 0 10px rgba(37, 211, 102, 0.4); 
        }

        button:active { transform: scale(0.95); }

        ul { list-style-type: none; padding: 0; max-width: 500px; margin: 0 auto; }

        li {
            background-color: #16213e;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #00f3ff;
            display: flex; justify-content: space-between; align-items: center;
            animation: aparecer 0.3s ease-out; text-align: left;
        }

        .info-producto { display: flex; flex-direction: column; }
        .nombre-item { font-weight: bold; font-size: 1.1em; color: #fff; }
        .detalle-item { font-size: 0.9em; color: #aaa; }
        
        .cantidad-badge { 
            background: #00f3ff; color: black; padding: 2px 8px; 
            border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-right: 5px;
        }

        .acciones { display: flex; gap: 5px; }

        .btn-delete {
            background: transparent; border: 1px solid #ff4d4d; color: #ff4d4d;
            border-radius: 5px; width: 35px; height: 35px; padding: 0; font-size: 16px;
        }
        .btn-delete:hover { background: #ff4d4d; color: white; }

        .btn-edit {
            background: transparent; border: 1px solid #ffcc00; color: #ffcc00;
            border-radius: 5px; width: 35px; height: 35px; padding: 0; font-size: 16px;
        }
        .btn-edit:hover { background: #ffcc00; color: black; }

        .caja-total {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            padding: 15px;
            border-radius: 10px;
            margin-top: 30px;
            display: inline-block;
            box-shadow: 0 0 20px rgba(150, 201, 61, 0.4);
            animation: aparecer 0.5s ease-out;
        }

        @keyframes aparecer {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>

<body>

    <div id="vista-clientes">
        <h1>üìÇ MIS PROYECTOS</h1>
        
        <div class="panel-control">
            <input type="text" id="nuevoClienteInput" placeholder="Nombre Cliente (Ej: Juan)">
            <div class="btn-container">
                <button class="btn-add" onclick="crearNuevoCliente()">+ CREAR NUEVO</button>
            </div>
        </div>

        <ul id="listaClientesVisual"></ul>
    </div>


    <div id="vista-presupuesto" style="display:none;">
        
        <div style="text-align: left; max-width: 500px; margin: 0 auto; margin-bottom: 10px;">
            <button class="btn-empty" onclick="volverInicio()">&#11013; VOLVER</button>
        </div>

        <h1 id="tituloPresupuesto">PRESUPUESTO</h1>
        
        <div class="panel-control">
            <input type="text" id="nombreInput" placeholder="Material (Ej: Cable)">
            <input type="number" id="cantidadInput" placeholder="Cantidad" min="1">
            <input type="number" id="precioInput" placeholder="Precio Unidad" min="0">
            
            <div class="btn-container">
                <button class="btn-add" onclick="agregarProducto()">GUARDAR ITEM</button>
                <button class="btn-excel" onclick="descargarExcel()">üì• EXCEL</button>
                <button class="btn-whatsapp" onclick="compartirWhatsapp()">üì± WHATSAPP</button>
            </div>
        </div>

        <ul id="listaVisual"></ul>

        <div class="caja-total">
            <h3>üí∞ TOTAL: $<span id="precioTotal">0</span></h3>
            <small style="display:block; margin-top:5px; font-size: 0.8em; color: #0f3460;">
                Items: <span id="contadorItems">0</span>
            </small>
        </div>
    </div>

    <script>
        var baseDatos = JSON.parse(localStorage.getItem('CODEPOP_DB')) || [];
        var clienteActualIndex = null;

        mostrarClientes();

        // --- GESTI√ìN DE CLIENTES ---

        function crearNuevoCliente() {
            var nombre = document.getElementById('nuevoClienteInput').value;
            
            if (nombre === "") {
                Swal.fire({ title: 'Falta nombre', icon: 'warning', background: '#16213e', color: '#fff' });
                return;
            }

            var nuevoCliente = {
                id: Date.now(), 
                nombre: nombre,
                items: [] 
            };

            baseDatos.push(nuevoCliente);
            guardarDB();
            
            document.getElementById('nuevoClienteInput').value = "";
            mostrarClientes(); 
        }

        function mostrarClientes() {
            var listaHTML = document.getElementById('listaClientesVisual');
            listaHTML.innerHTML = "";

            if(baseDatos.length === 0) {
                listaHTML.innerHTML = "<p style='color:#aaa'>No tienes proyectos a√∫n.</p>";
                return;
            }

            baseDatos.forEach(function(cliente, index) {
                var totalItems = cliente.items.length;
                
                var html = `
                    <li>
                        <div class="info-producto">
                            <span class="nombre-item">${cliente.nombre}</span>
                            <span class="detalle-item">${totalItems} items guardados</span>
                        </div>
                        <div>
                             <button class="btn-delete" onclick="borrarCliente(${index})">‚úï</button>
                             <button class="btn-open" onclick="abrirPresupuesto(${index})">ABRIR ‚ûú</button>
                        </div>
                    </li>
                `;
                listaHTML.innerHTML += html;
            });
        }

        function borrarCliente(index) {
            Swal.fire({
                title: '¬øBorrar proyecto?',
                text: "Se perder√°n todos los materiales de este cliente.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                background: '#16213e', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    baseDatos.splice(index, 1);
                    guardarDB();
                    mostrarClientes();
                }
            })
        }

        function abrirPresupuesto(index) {
            clienteActualIndex = index;
            var cliente = baseDatos[index];

            document.getElementById('tituloPresupuesto').innerText = "OBRA: " + cliente.nombre.toUpperCase();
            document.getElementById('vista-clientes').style.display = 'none';
            document.getElementById('vista-presupuesto').style.display = 'block';

            actualizarVistaPresupuesto();
        }

        function volverInicio() {
            clienteActualIndex = null; 
            document.getElementById('vista-presupuesto').style.display = 'none';
            document.getElementById('vista-clientes').style.display = 'block';
            mostrarClientes(); 
        }


        // --- FUNCIONES DEL PRESUPUESTO ---

        function agregarProducto() {
            var nombre = document.getElementById('nombreInput').value;
            var cantidad = document.getElementById('cantidadInput').value;
            var precio = document.getElementById('precioInput').value;

            if (nombre === "" || cantidad === "" || precio === "") return;

            var nuevoItem = {
                nombre: nombre,
                cantidad: parseInt(cantidad),
                precio: parseFloat(precio)
            };

            baseDatos[clienteActualIndex].items.push(nuevoItem);
            
            document.getElementById('nombreInput').value ="";
            document.getElementById('cantidadInput').value = "";
            document.getElementById('precioInput').value = "";
            
            document.getElementById('nombreInput').focus();
            
            guardarDB();
            actualizarVistaPresupuesto();
            
            Swal.fire({
                position: 'top-end', icon: 'success', title: 'Guardado', 
                showConfirmButton: false, timer: 800, background: '#16213e', color: '#fff'
            });
        }

        function actualizarVistaPresupuesto() {
            var listaHtml = document.getElementById('listaVisual');
            listaHtml.innerHTML = "";
            
            var itemsCliente = baseDatos[clienteActualIndex].items;
            var totalAcumulado = 0;

            itemsCliente.forEach(function(producto, i) {
                var subtotal = producto.cantidad * producto.precio;
                totalAcumulado += subtotal;

                var info = `
                    <div class="info-producto">
                        <span class="nombre-item">
                            <span class="cantidad-badge">${producto.cantidad}x</span> 
                            ${producto.nombre}
                        </span>
                        <span class="detalle-item">
                            $${producto.precio.toLocaleString()} c/u | Subtotal: $${subtotal.toLocaleString()}
                        </span>
                    </div>
                `;
                var botones = `
                    <div class="acciones">
                        <button class="btn-edit" onclick="editarItem(${i})">‚úé</button>
                        <button class="btn-delete" onclick="borrarItem(${i})">‚úï</button>
                    </div>
                `;
                listaHtml.innerHTML += `<li>${info} ${botones}</li>`;   
            });

            document.getElementById('precioTotal').innerText = totalAcumulado.toLocaleString();
            document.getElementById('contadorItems').innerText = itemsCliente.length;
        }

        function borrarItem(i) {
            baseDatos[clienteActualIndex].items.splice(i, 1);
            guardarDB();
            actualizarVistaPresupuesto();
        }

        function editarItem(i) {
            var item = baseDatos[clienteActualIndex].items[i];
            document.getElementById('nombreInput').value = item.nombre;
            document.getElementById('cantidadInput').value = item.cantidad;
            document.getElementById('precioInput').value = item.precio;
            
            borrarItem(i); 
        }

        function guardarDB() {
            localStorage.setItem('CODEPOP_DB', JSON.stringify(baseDatos));
        }

        function descargarExcel() {
            var cliente = baseDatos[clienteActualIndex];
            if (cliente.items.length === 0) {
                Swal.fire({ icon: 'info', title: 'Vac√≠o', text: 'Agrega items primero', background: '#16213e', color: '#fff' });
                return;
            }

            var datos = cliente.items.map(item => ({
                "Producto": item.nombre, "Cantidad": item.cantidad, 
                "Precio Unitario": item.precio, "Subtotal": item.cantidad * item.precio
            }));

            var hoja = XLSX.utils.json_to_sheet(datos);
            var libro = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(libro, hoja, "Presupuesto");
            XLSX.writeFile(libro, "Presupuesto_" + cliente.nombre + ".xlsx");
        }

        // --- WHATSAPP SIMPLE ---
        function compartirWhatsapp() {
            var cliente = baseDatos[clienteActualIndex];
            var items = cliente.items;
            
            if (items.length === 0) {
                Swal.fire({ icon: 'info', title: 'Vac√≠o', text: 'Agrega materiales para compartir', background: '#16213e', color: '#fff' });
                return;
            }

            // 1. Calculamos Total ($)
            var total = 0;
            items.forEach(i => total += (i.cantidad * i.precio));

            // 2. Armamos el mensaje simple que pediste
            var texto = `Hola ${cliente.nombre}, el total de materiales para la obra es $${total.toLocaleString()}. Son ${items.length} items. Av√≠same si avanzamos.`;

            // 3. Enviamos
            var textoCodificado = encodeURIComponent(texto);
            window.open(`https://wa.me/?text=${textoCodificado}`, '_blank');
        }
        
        // TECLAS R√ÅPIDAS
         document.getElementById('nombreInput').addEventListener('keydown', function(e) {
            if (e.key === "Enter") { e.preventDefault(); document.getElementById('cantidadInput').focus(); }
        });
        document.getElementById('cantidadInput').addEventListener('keydown', function(e) {
            if (e.key === "Enter") { e.preventDefault(); document.getElementById('precioInput').focus(); }
        });
        document.getElementById('precioInput').addEventListener('keydown', function(e) {
            if (e.key === "Enter") agregarProducto();
        });

    </script>
</body>
</html>
